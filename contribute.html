<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <link href="css/styles.css" rel="stylesheet" />
    <link href="css/gallery.css" rel="stylesheet" />
    <link href="css/layout.css" rel="stylesheet" />
    <link href="css/form.css" rel="stylesheet" />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Navigation-->
    <nav
      class="navbar navbar-expand-lg navbar-light"
      id="mainNav"
      style="background-color: rgb(8, 8, 8)"
    >
      <div class="container px-4 px-lg-5">
        <a class="navbar-brand" href="index.html">Roots of Resilience</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarResponsive"
          aria-controls="navbarResponsive"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          Menu
          <i class="fas fa-bars"></i>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ms-auto py-4 py-lg-0">
            <li class="nav-item">
              <a class="nav-link px-lg-3 py-3 py-lg-4" href="index.html"
                >Home</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link px-lg-3 py-3 py-lg-4" href="gallery.html"
                >Gallery</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link px-lg-3 py-3 py-lg-4" href="map.html">Map</a>
            </li>
            <li class="nav-item">
              <a class="nav-link px-lg-3 py-3 py-lg-4" href="contribute.html"
                >Contribute</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- Page Header-->
    <h1 style="padding-top: 100px">Church Information Submission Form</h1>
    <!-- Main Content-->
    <title>Church Information Submission Form</title>
    <div id="map"></div>

    <form id="churchForm" style="margin-left: 40px; margin-top: 70px">
      <!-- Geometry Information -->
      <fieldset>
        <legend>Geometry Information</legend>

        <div class="form-group">
          <label for="lon">Longitude<span style="color: red">*</span></label>
          <input type="number" id="lon" name="lon" step="any" required />
        </div>

        <div class="form-group">
          <label for="lat">Latitude<span style="color: red">*</span></label>
          <input type="number" id="lat" name="lat" step="any" required />
        </div>
      </fieldset>

      <!-- Church Properties -->
      <fieldset>
        <legend>Church Properties</legend>
        <!-- TODO make this work with file uploads -->
        <div class="form-group">
          <label for="churchPhoto">Church Photo URL</label>
          <input
            type="url"
            id="churchPhoto"
            name="churchPhoto"
            placeholder="url of church image"
          />
        </div>

        <div class="form-group">
          <label for="pastorPhoto">Pastor Photo URL</label>
          <input
            type="url"
            id="pastorPhoto"
            name="pastorPhoto"
            placeholder="url of pastor image"
          />
        </div>

        <div class="form-group">
          <label for="churchName"
            >Church Name<span style="color: red">*</span></label
          >
          <input type="text" id="churchName" name="churchName" required />
        </div>

        <div class="form-group">
          <label for="address"
            >Church Address<span style="color: red">*</span></label
          >
          <input type="text" id="address" name="address" required />
        </div>

        <div class="form-group">
          <label for="founder">Founder</label>
          <input type="text" id="founder" name="founder" />
        </div>

        <div class="form-group">
          <label for="pastor">Pastor</label>
          <input type="text" id="pastor" name="pastor" />
        </div>

        <div class="form-group">
          <label for="congregation">Congregation</label>
          <input type="text" id="congregation" name="congregation" />
        </div>

        <div class="form-group">
          <label for="churchContactInfo">Church Contact Info</label>
          <input type="text" id="churchContactInfo" name="churchContactInfo" />
        </div>

        <div class="form-group">
          <label for="churchWebsite">Church Website</label>
          <input
            type="url"
            id="churchWebsite"
            name="churchWebsite"
            placeholder="https://stpeterchurch.org"
          />
        </div>

        <div class="form-group">
          <label for="activismMoments">Activism Moments</label>
          <textarea
            id="activismMoments"
            name="activismMoments"
            placeholder="Describe activism moments..."
          ></textarea>
        </div>

        <div class="form-group">
          <label for="organizations">Organizations</label>
          <textarea
            id="organizations"
            name="organizations"
            placeholder="List organizations..."
          ></textarea>
        </div>

        <div class="form-group">
          <label for="personalStories">Personal Stories</label>
          <textarea
            id="personalStories"
            name="personalStories"
            placeholder="Share personal stories..."
          ></textarea>
        </div>

        <div class="form-group">
          <label for="contributorName"
            >Contributor Name<span style="color: red">*</span></label
          >
          <input
            type="text"
            id="contributorName"
            name="contributorName"
            required
          />
        </div>

        <div class="form-group">
          <label for="contributorEmail"
            >Contributor Email<span style="color: red">*</span></label
          >
          <input
            type="email"
            id="contributorEmail"
            name="contributorEmail"
            required
          />
        </div>

        <div class="form-group">
          <label for="contributorPhoneNumber">Contributor Phone Number</label>
          <input
            type="tel"
            id="contributorPhoneNumber"
            name="contributorPhoneNumber"
            placeholder="+1234567890"
          />
        </div>

        <div class="form-group">
          <label for="contributorAffiliation">Contributor Affiliation</label>
          <input
            type="text"
            id="contributorAffiliation"
            name="contributorAffiliation"
          />
        </div>

        <div class="form-group">
          <label for="contributorPreferredContactMethod"
            >Preferred Contact Method</label
          >
          <select
            id="contributorPreferredContactMethod"
            name="contributorPreferredContactMethod"
          >
            <option value="">--Select--</option>
            <option value="Email">Email</option>
            <option value="Phone">Phone</option>
            <option value="Either">Either</option>
          </select>
        </div>
      </fieldset>

      <button type="submit">Submit</button>
    </form>

    <div class="message" id="message"></div>

    <script>
      document
        .getElementById("churchForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault(); // Prevent default form submission

          // Clear previous messages
          const messageDiv = document.getElementById("message");
          messageDiv.textContent = "";
          messageDiv.className = "message";

          // Gather form data
          const lon = parseFloat(document.getElementById("lon").value);
          const lat = parseFloat(document.getElementById("lat").value);

          if (isNaN(lon) || isNaN(lat)) {
            messageDiv.textContent =
              "Please enter valid longitude and latitude values.";
            messageDiv.classList.add("error");
            messageDiv.style.display = "block";
            return;
          }

          // Construct the payload
          const payload = {
            type: "FormEntry",
            properties: {
              churchPhoto:
                document.getElementById("churchPhoto").value.trim() || "", // TODO enable file upload
              pastorPhoto:
                document.getElementById("pastorPhoto").value.trim() || "",
              churchName: document.getElementById("churchName").value.trim(),
              address: document.getElementById("address").value.trim(),
              lon: lon,
              lat: lat,
              founder: document.getElementById("founder").value.trim() || "",
              pastor: document.getElementById("pastor").value.trim() || "",
              congregation:
                document.getElementById("congregation").value.trim() || "",
              churchContactInfo:
                document.getElementById("churchContactInfo").value.trim() || "",
              churchWebsite:
                document.getElementById("churchWebsite").value.trim() || "",
              activismMoments:
                document.getElementById("activismMoments").value.trim() || "",
              organizations:
                document.getElementById("organizations").value.trim() || "",
              personalStories:
                document.getElementById("personalStories").value.trim() || "",
              contributorName: document
                .getElementById("contributorName")
                .value.trim(),
              contributorEmail: document
                .getElementById("contributorEmail")
                .value.trim(),
              contributorPhoneNumber:
                document
                  .getElementById("contributorPhoneNumber")
                  .value.trim() || "",
              contributorAffiliation:
                document
                  .getElementById("contributorAffiliation")
                  .value.trim() || "",
              contributorPrefferedContactMethod:
                document.getElementById("contributorPreferredContactMethod")
                  .value || "",
            },
            geometry: {
              type: "Point",
              coordinates: [lon, lat],
            },
          };

          try {
            const response = await fetch("/submit", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            if (response.ok) {
              const data = await response.json();
              messageDiv.textContent =
                "Form submitted successfully, thank you!";
              messageDiv.classList.add("success");
              messageDiv.style.display = "block";
              document.getElementById("churchForm").reset(); // Reset the form
            } else {
              const errorData = await response.json();
              messageDiv.textContent = `Error: ${errorData.error || "Something went wrong."}`;
              messageDiv.classList.add("error");
              messageDiv.style.display = "block";
            }
          } catch (error) {
            console.error("Error:", error);
            messageDiv.textContent = "An unexpected error occurred.";
            messageDiv.classList.add("error");
            messageDiv.style.display = "block";
          }
        });
    </script>

    <!-- Mapbox JS -->
    <!-- TODO find something better to do with this map -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script>
      // ADD YOUR MAPBOX ACCESS TOKEN
      mapboxgl.accessToken =
        "pk.eyJ1IjoiZWZhaXRoMSIsImEiOiJjbTNpMm00d3MwbWZiMmpwdmZ6ajk1MWpxIn0.QLpkPhqyjTw3DgiFigg0mQ";

      // Initialize the map
      const map = new mapboxgl.Map({
        container: "map", // Container ID
        style: "mapbox://styles/mapbox/streets-v11", // Map style
        center: [0, 0], // Initial map center [lon, lat]
        zoom: 2, // Initial zoom level
      });

      // Add map controls
      map.addControl(new mapboxgl.NavigationControl());

      // Marker for selected location
      let marker;

      // Click event to get coordinates
      map.on("click", (e) => {
        const lon = e.lngLat.lng;
        const lat = e.lngLat.lat;

        // Update form fields with coordinates
        document.getElementById("lon").value = lon.toFixed(6);
        document.getElementById("lat").value = lat.toFixed(6);

        // Place or move marker on the map
        if (marker) {
          marker.setLngLat([lon, lat]);
        } else {
          marker = new mapboxgl.Marker().setLngLat([lon, lat]).addTo(map);
        }
      });
    </script>

    <!-- Footer-->
    <footer id="footer">
      <a
        href="https://www.instagram.com/savingplaces"
        target="_blank"
        id="instagram-link"
      >
        Connect with us on Instagram! @savingplaces
      </a>
      <span>&#169; 2024 Roots of Resilience. All Rights Reserved.</span>
    </footer>
  </body>
</html>
